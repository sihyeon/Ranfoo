<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title></title>
<SCRIPT LANGUAGE="JavaScript">
//일반 대화 메세지 전송 - 3000
var CHAT_SERVER_UTL="/index.jsp";
function sendMsg(){

	var queryStr = "?div=3000&index="+lastIndex+"&chatServerNum="+chatServerNum;

	var req = getHTTPObject();
	req.onreadystatechange = getReadyStateHandler(req, voidFunction);
	req.open("POST", CHAT_SERVER_UTL+queryStr, true);
	req.setRequestHeader("alias",escape(document.fm3.alias.value));
	req.setRequestHeader("msg",escape(document.fm3.chatLine.value));
	req.send();

	document.fm3.chatLine.value = "";
}

function keySendMsg(){
	if(event.keyCode==13)
		sendMsg();
}

//메세지 갱신 요청 - 4000
function refreshMsg(){

	var queryStr = "?div=4000&chatServerNum="+chatServerNum+"&index="+lastIndex;

	var req = getHTTPObject();
	req.onreadystatechange = getReadyStateHandler(req, refreshMessage);
	req.open("POST", CHAT_SERVER_UTL+queryStr, true);
	req.setRequestHeader("alias",escape(document.fm3.alias.value));
	req.send();
}

//메세지 갱신 요청에 대한 응답처리
function refreshMessage(respTxt){
	var splitStr;

	splitStr = respTxt.split("|");

	//2010:대화방입장, 2110:대화방퇴장, 3010:일반대화
	switch(splitStr[0]){
		case "3010":
			document.fm3.chatArea.value += unescape(splitStr[3])+">"+unescape(splitStr[4])+"\n";
			document.fm3.chatArea.doScroll();
			lastIndex = splitStr[1];
		break;

		//대화리스트에서 입장한 아이디추가
		case "2010":
			var op = document.createElement("option");
			op.text = unescape(splitStr[3]);
			op.value = splitStr[2]+":"+splitStr[3];
			document.fm3.userList.add(op);

			document.fm3.chatArea.value += unescape(splitStr[3])+"> 대화방에 입장했습니다. \n";
			document.fm3.chatArea.doScroll();
			lastIndex = splitStr[1];
		break;
	}
	intervalId = setTimeout("refreshMsg()",500);
}
</SCRIPT>
</head>
<body>
	<div id='chat'>
            <form name='chat_form' onunload='exitPage()'>
            <table border='0' width='600' height='200'>
            <tr height='20' align='center'>
                <td width='400'>대화창</td><td width='200'>대화참여자</td>
            </tr>
            <tr height='150' align='center'>
                <td>
                    <textarea name='chatArea' rows='9' cols='50' readonly></textarea>
                </td>
                <td>
                    <select name='userList' size='9' cols='10' style='width:300'></select>
                </td>
            </tr>
            <tr height='30' align='center'>
                <td colspan='2'><input type='text' name='alias' size='15' readonly> <input type='text' name='chatLine' size='50' onkeydown='keySendMsg()'> <input type='button' value='Send' onclick='sendMsg()'></td>
            </tr>
            </table>
        </form>
	</div>
</body>
</html>